<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Stream RPi Schermo Intero</title>
    <style>
        /* RESET BASE */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            background-color: #000; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #video-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center; 
            align-items: center; 
            position: relative;
        }

        #stream {
            object-fit: contain; 
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ELEMENTI OVERLAY */
        .overlay-element {
            position: absolute;
            padding: 10px 18px; 
            font-weight: bold;
            border-radius: 12px; 
            z-index: 20; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        .top-right { top: 15px; right: 15px; }
        .top-left { top: 15px; left: 15px; }
        .bottom-left { bottom: 15px; left: 15px; }
        
        /* POSIZIONE DEL MONITOR VELOCIT√Ä (Sotto il pulsante Wakeup o accanto) */
        .top-right-info {
            top: 70px; /* Un po' pi√π in basso rispetto al pulsante Start */
            right: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #00e5ff; /* Ciano stile cyberpunk */
            font-family: 'Consolas', monospace;
            font-size: 12px;
            border: 1px solid rgba(0, 229, 255, 0.3);
            display: none; /* Nascosto di default */
            text-align: right;
            min-width: 120px;
        }

        /* PULSANTI */
        button.overlay-element {
            background-color: #4CAF50; 
            color: white;
            border: none; 
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        button.overlay-element:hover {
            background-color: #45A049; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
        }
        button.overlay-element:disabled {
            background-color: #888;
            cursor: not-allowed;
            transform: none;
        }
        
        #status-overlay {
            background-color: rgba(20, 20, 20, 0.8);
            color: white;
            font-size: 13px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        #quality-button {
            background-color: #2196F3; 
            color: white;
            z-index: 30; 
        }
        #quality-button:hover {
            background-color: #1976D2;
        }

        /* MENU IMPOSTAZIONI */
        #settings-menu {
            position: absolute;
            bottom: -450px; /* Nascosto */
            left: 15px;
            width: 280px;
            background-color: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            z-index: 25; 
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        #settings-menu.active {
            bottom: 70px; 
        }

        h3 {
            margin-top: 0; 
            font-size: 16px; 
            border-bottom: 1px solid #555; 
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        .control-group span {
            float: right;
            color: #4CAF50;
            font-weight: bold;
        }
        
        /* Toggle Switch Style per la checkbox */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
        }
        .toggle-row label {
            font-size: 14px;
            color: white;
            margin: 0;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4CAF50;
            cursor: pointer;
        }

        input[type=range] {
            width: 100%;
            accent-color: #2196F3;
            cursor: pointer;
            height: 5px;
            background: #555;
            border-radius: 5px;
            outline: none;
        }

        select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            background: #444;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

    <div id="video-container">
        <img id="stream" src="" alt="In attesa del video...">
    </div>

    <!-- STATUS (Top Left) -->
    <div id="status-overlay" class="overlay-element top-left">
        Stato: <span id="status" style="color: orange;">Disconnesso</span>
    </div>

    <!-- WAKE UP BUTTON (Top Right) -->
    <button id="wakeup-button" class="overlay-element top-right">
        ‚ö° Avvia Server
    </button>

    <!-- SPEED MONITOR DISPLAY (Top Right - Sotto il pulsante) -->
    <div id="speed-display" class="overlay-element top-right-info">
        <div>‚¨Ü UP: <span id="speed-up">0.00</span> Mbps</div>
        <div style="margin-top:4px;">‚¨á DOWN: <span id="speed-down">0.00</span> Mbps</div>
    </div>

    <!-- MENU SETTAGGI -->
    <div id="settings-menu">
        <h3>‚öôÔ∏è Impostazioni Stream</h3>
        
        <!-- TARGET FPS -->
        <div class="control-group">
            <label>Target FPS: <span id="val-fps">50</span></label>
            <input type="range" id="in-fps" min="1" max="60" value="50">
        </div>

        <!-- WIDTH -->
        <div class="control-group">
            <label>Larghezza (Width)</label>
            <select id="in-width">
                <option value="320">320 px (Bassa)</option>
                <option value="480">480 px</option>
                <option value="640" selected>640 px (Standard)</option>
                <option value="800">800 px</option>
                <option value="1024">1024 px</option>
                <option value="1280">1280 px (HD)</option>
            </select>
        </div>

        <!-- HEIGHT -->
        <div class="control-group">
            <label>Altezza (Height)</label>
            <select id="in-height">
                <option value="240">240 px (Bassa)</option>
                <option value="360">360 px</option>
                <option value="480" selected>480 px (Standard)</option>
                <option value="600">600 px</option>
                <option value="720">720 px (HD)</option>
                <option value="1080">1080 px (FHD)</option>
            </select>
        </div>

        <!-- QUALITY -->
        <div class="control-group">
            <label>Qualit√† JPEG: <span id="val-quality">50</span>%</label>
            <input type="range" id="in-quality" min="1" max="100" value="50">
        </div>

        <!-- MONITOR VELOCITA TOGGLE -->
        <div class="toggle-row">
            <label for="in-speed-toggle">üìä Mostra Velocit√† Rete</label>
            <input type="checkbox" id="in-speed-toggle">
        </div>
    </div>

    <!-- TOGGLE BUTTON (Bottom Left) -->
    <button id="quality-button" class="overlay-element bottom-left">
        ‚öôÔ∏è Qualit√† Grafica
    </button>


    <script>
        // --- CONFIGURAZIONE URL ---
        const STREAMING_SERVER_URL = 'https://server-webrtc-mvno.onrender.com';
        const COMMAND_SERVER_URL = 'https://comandi-server.onrender.com'; 
        
        // --- RIFERIMENTI DOM ---
        const statusElement = document.getElementById('status');
        const wakeupButton = document.getElementById('wakeup-button');
        const statusOverlay = document.getElementById('status-overlay');
        const imgElement = document.getElementById('stream');
        
        const qualityButton = document.getElementById('quality-button');
        const settingsMenu = document.getElementById('settings-menu');

        // Display Velocit√†
        const speedDisplay = document.getElementById('speed-display');
        const speedUpVal = document.getElementById('speed-up');
        const speedDownVal = document.getElementById('speed-down');

        // Inputs
        const inFps = document.getElementById('in-fps');
        const inWidth = document.getElementById('in-width');
        const inHeight = document.getElementById('in-height');
        const inQuality = document.getElementById('in-quality');
        const inSpeedToggle = document.getElementById('in-speed-toggle');
        
        // Labels
        const valFps = document.getElementById('val-fps');
        const valQuality = document.getElementById('val-quality');

        let socket = null; 

        // --- GESTIONE UI MENU ---
        
        qualityButton.addEventListener('click', () => {
            settingsMenu.classList.toggle('active');
        });

        function updateLabels() {
            valFps.innerText = inFps.value;
            valQuality.innerText = inQuality.value;
        }

        function sendConfig() {
            if(!socket) return;
            
            const newConfig = {
                target_fps: parseInt(inFps.value),
                width: parseInt(inWidth.value),
                height: parseInt(inHeight.value),
                jpeg_quality: parseInt(inQuality.value)
            };

            console.log("üì§ Invio config:", newConfig);
            socket.emit('update_config', newConfig);
        }

        // --- GESTIONE MONITOR VELOCIT√Ä ---
        inSpeedToggle.addEventListener('change', () => {
            const isActive = inSpeedToggle.checked;
            
            // Mostra/Nascondi il box in alto a destra
            speedDisplay.style.display = isActive ? 'block' : 'none';
            
            // Invia comando al server (che lo girer√† a Python)
            if(socket) {
                console.log("üìä Toggle Velocit√†:", isActive);
                socket.emit('toggle_speed_monitoring', isActive);
            }
        });

        // --- EVENT LISTENERS CONTROLLI ---
        [inFps, inQuality].forEach(el => {
            el.addEventListener('input', updateLabels);
            el.addEventListener('change', sendConfig);
        });
        [inWidth, inHeight].forEach(el => {
            el.addEventListener('change', sendConfig);
        });


        // --- GESTIONE SERVER ---

        function wakeUpServer() {
            wakeupButton.disabled = true;
            wakeupButton.innerText = '‚öôÔ∏è Avvio...';
            statusElement.innerText = "Wakeup...";
            statusElement.style.color = "yellow";
            
            Promise.all([
                fetch(STREAMING_SERVER_URL),
                fetch(COMMAND_SERVER_URL)
            ])
            .then(() => {
                wakeupButton.innerText = '‚úÖ Attivi!';
                setTimeout(connectSocket, 1500); 
            })
            .catch(err => {
                console.error("Errore Wakeup:", err);
                wakeupButton.innerText = '‚ùå Errore';
                statusElement.innerText = "Errore";
                wakeupButton.disabled = false;
            });
        }

        function connectSocket() {
            if (socket) socket.disconnect();
            
            socket = io(STREAMING_SERVER_URL);

            socket.on('connect', () => {
                console.log("‚úÖ Socket Connesso");
                statusElement.innerText = "Connesso";
                statusElement.style.color = "lightgreen";
                
                wakeupButton.style.display = 'none'; 
                qualityButton.style.display = 'block';
                
                socket.emit('get_config');
                
                // Sincronizziamo lo stato della velocit√† se ci riconnettiamo
                if(inSpeedToggle.checked) {
                    socket.emit('toggle_speed_monitoring', true);
                }
            });

            socket.on('disconnect', () => {
                console.log("‚ùå Socket Disconnesso");
                statusElement.innerText = "Disconnesso";
                statusElement.style.color = "red";
                
                wakeupButton.style.display = 'block'; 
                wakeupButton.innerText = '‚ö° Avvia Server'; 
                wakeupButton.disabled = false;
                
                qualityButton.style.display = 'none';
                settingsMenu.classList.remove('active');
                speedDisplay.style.display = 'none'; // Nascondi monitor se disconnesso
            });

            // STREAM
            socket.on('stream_display', (data) => {
                imgElement.src = 'data:image/jpeg;base64,' + data;
                if (statusOverlay.style.opacity !== '0') {
                    statusOverlay.style.transition = 'opacity 5s ease-in 3s';
                    statusOverlay.style.opacity = '0';
                }
            });

            // CONFIG
            socket.on('config_updated', (config) => {
                if(config.target_fps) inFps.value = config.target_fps;
                if(config.width) inWidth.value = config.width;
                if(config.height) inHeight.value = config.height;
                if(config.jpeg_quality) inQuality.value = config.jpeg_quality;
                updateLabels();
            });

            // DATI VELOCIT√Ä (Ogni secondo)
            socket.on('display_speed', (data) => {
                // data = { upload: 12.5, download: 0.5 }
                speedUpVal.innerText = data.upload.toFixed(2);
                speedDownVal.innerText = data.download.toFixed(2);
            });
        }

        qualityButton.style.display = 'none';
        wakeupButton.addEventListener('click', wakeUpServer);
        connectSocket();

    </script>

</body>
</html>
